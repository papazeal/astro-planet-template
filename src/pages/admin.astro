---
import Layout from "../layouts/Layout.astro";
import PlanetCMS from "../components/CMS/PlanetCMS.svelte";
import { SignOutButton } from "@clerk/astro/components";
import { Code } from "astro:components";

import { commitFiles } from "../libs/github";
import { writeToFile } from "../libs/file";

import data from "/content/data.json" assert { type: "json" };
import modelJSON from "/content/model.json" assert { type: "json" };
const model = modelJSON.groups;

const user = await Astro.locals.currentUser();

if (Astro.request.method === "POST") {
  // const formData = await Astro.request.formData();
  // let processedFormObject: any = {};
  // for (const [key, value] of formData.entries()) {
  //   let [group, fieldID] = key.split("-");
  //   if (group && fieldID) {
  //     if (!processedFormObject[group]) {
  //       processedFormObject[group] = {};
  //     }
  //     processedFormObject[group][fieldID] = value;
  //   }
  // }
  let processedFormObject = await Astro.request.json();
  console.log("formData", processedFormObject);

  if (import.meta.env.MODE === "production") {
    await commitFiles(JSON.stringify(processedFormObject, null, "\t"));
  } else {
    console.log("save file to local folder");
    writeToFile("data.json", JSON.stringify(processedFormObject, null, "\t"));
  }

  return Response.json({ message: "Data saved successfully" });
}

const submit = async (e) => {
  e.preventDefault();
  toast.success("Changes saved successfully");
};
---

<Layout>
  <div
    class="shadow-lg bg-white p-4 px-8 md:flex top-0 left-0 w-full z-50 !hidden"
  >
    <div class="flex gap-4">
      <div>{user?.emailAddresses[0].emailAddress}</div>
      <a href={Astro.url.origin}>{Astro.url.origin}</a>
    </div>
    <div class="ml-auto flex gap-4 items-center mt-4 md:mt-0">
      <SignOutButton asChild={true}
        ><button
          class="border border-slate-500 px-4 py-1 rounded cursor-pointer"
          >Sign Out</button
        ></SignOutButton
      >
      <input
        onclick="submit(e)"
        type="submit"
        class="bg-slate-800 text-white px-6 py-1 rounded cursor-pointer"
        value="Save Changes"
      />
    </div>
  </div>
  <div class="p-8 hidden">
    <div class="">
      <div>MODE: {import.meta.env.MODE}</div>
      <div>VERCEL_GIT_REPO_SLUG: {import.meta.env.VERCEL_GIT_REPO_SLUG}</div>
      <div>
        VERCEL_GIT_REPO_OWNER: {import.meta.env.VERCEL_GIT_REPO_OWNER}
      </div>
    </div>
    <div class="hidden">
      data
      <Code
        code={JSON.stringify(data, null, "\t")}
        lang="js"
        class="p-4 rounded-lg mt-2 text-base"
      />
      model
      <Code
        code={JSON.stringify(model, null, "\t")}
        class="p-4 rounded-lg mt-2 text-base"
      />
    </div>
  </div>
  <PlanetCMS
    client:load
    model={model}
    data={data}
    user={user?.emailAddresses[0].emailAddress}
    website={Astro.url.origin}
  />
</Layout>
